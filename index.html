<!DOCTYPE html>
<html lang="fr">
<head>
    <title></title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.46.0/codemirror.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.46.0/theme/material.css" />
    <link href="https://fonts.googleapis.com/css?family=Merriweather|Raleway&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Merriweather', sans-serif;
        }
        .CodeMirror {
            width: 49%;
            float: left;
            height: 500px;
        }
        button {
            font-size: 16px;
            border-radius: 5px;
        }
        #preview{
            width: 49%;
            float: left;
            padding: 0 10px;
            color: #F5F5F5;
            background-color: #263238;
            height: 500px;
            border-left: solid 1px white;
        }
        #preview a{
            color: #3E92CC;
        }
        blockquote {
            border-left: solid 3px grey;
            padding-left: 10px;
        }
    </style>
</head>
<body>
<label for="textarea">Zone de texte</label><br>
<textarea id="textarea"></textarea>
<div id="preview"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.46.0/codemirror.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.46.0/mode/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const elementBold = `<button type="button" data-val="bold" class="btn btn-default"><i class="fas fa-bold"></i></button>`;
    const elementItalic = `<button type="button" data-val="italic" class="btn btn-default"><i class="fas fa-italic"></i></button>`;
    const elementStrikeThrough = `<button type="button" data-val="strikethrough" class="btn btn-default"><i class="fas fa-strikethrough"></i></button>`;
    const blockquote = `<button type="button" data-val="blockquote" class="btn btn-default"><i class="fas fa-quote-right"></i></button>`;

    const h1 = `<button type="button" data-val="h1" class="btn btn-default">H1</button>`;
    const h2 = `<button type="button" data-val="h2" class="btn btn-default">H2</button>`;
    const h3 = `<button type="button" data-val="h3" class="btn btn-default">H3</button>`;
    const h4 = `<button type="button" data-val="h4" class="btn btn-default">H4</button>`;
    const h5 = `<button type="button" data-val="h5" class="btn btn-default">H5</button>`;
    const h6 = `<button type="button" data-val="h6" class="btn btn-default">H6</button>`;

    const ulList = `<button type="button" data-val="ul-list" class="btn btn-default"><i class="fas fa-list-ul"></i></button>`;
    const olList = `<button type="button" data-val="ol-list" class="btn btn-default"><i class="fas fa-list-ol"></i></button>`;

    const hr = `<button type="button" data-val="hr" class="btn btn-default"><i class="fas fa-minus"></i></button>`;
    const link = `<button type="button" data-val="link" class="btn btn-default"><i class="fas fa-link"></i></button>`;
    const image = `<button type="button" data-val="image" class="btn btn-default"><i class="fas fa-image"></i></button>`;
    const table = `<button type="button" data-val="table" class="btn btn-default"><i class="fas fa-table"></i></button>`;
    const emoji = `<button type="button" data-val="emoji" class="btn btn-default"><i class="far fa-smile"></i></button>`;

    const terminal = `<button type="button" data-val="line" class="btn btn-default"><i class="fas fa-terminal"></i></button>`;
    const code = `<button type="button" data-val="code" class="btn btn-default"><i class="fas fa-file-code"></i></button>`;
    const github = `<button type="button" data-val="github" class="btn btn-default"><i class="fab fa-github"></i></button>`;

    const stylesList = `${elementBold} ${elementItalic} ${elementStrikeThrough} ${blockquote}`;
    const titleList = `${h1} ${h2} ${h3} ${h4} ${h5} ${h6}`;
    const lists =  `${ulList} ${olList}`;
    const other = `${hr} ${link} ${image} ${table} ${emoji}`;
    const codes = `${terminal} ${code} ${github}`;

    const menu = `<div>${stylesList} ${titleList} ${lists} ${other} ${codes}</div>`;

    $("#textarea").before(menu);

    const editor = CodeMirror.fromTextArea(document.getElementById("textarea"), {
        mode: 'text/html',
        lineNumbers: true,
        theme: "material",
        extraKeys: {"Enter": "newlineAndIndentContinueMarkdownList"}
    }).on('change', editor => {
        document.getElementById('preview').innerHTML =
            marked(editor.getValue());

        start(editor);
    });

    function start(editor)
    {
        $('button').click(function(){

            const val = $(this).data('val');
            const string = editor.getSelection();

            switch(val){
                case 'bold':
                    setStyle(editor, string, '*', 2);
                    break;

                case 'italic':
                    setStyle(editor, string, '*', 1);
                    break;

                case 'strikethrough':
                    setStyle(editor, string, '~', 2);
                    break;

                case 'blockquote':
                    setBlockquote(editor, string, '>', 1);
                    break;

                case 'h1':
                    setTitle(editor, string, '#', 1);
                    break;

                case 'h2':
                    setTitle(editor, string, '#', 2);
                    break;

                case 'h3':
                    setTitle(editor, string, '#', 3);
                    break;

                case 'h4':
                    setTitle(editor, string, '#', 4);
                    break;

                case 'h5':
                    setTitle(editor, string, '#', 5);
                    break;

                case 'h6':
                    setTitle(editor, string, '#', 6);
                    break;

                case 'ul-list':
                    setUlList(editor, string, '*', 1);
                    break;

                case 'ol-list':
                    setOlList(editor, string, '1', 1);
                    break;

                case 'hr':
                    console.log('todo');
                    break;

                case 'link':
                    console.log('todo');
                    break;

                case 'image':
                    console.log('todo');
                    break;

                case 'table':
                    console.log('todo');
                    break;

                case 'emoji':
                    console.log('todo');
                    break;

                case 'line':
                    console.log('todo');
                    break;

                case 'code':
                    console.log('todo');
                    break;

                case 'github':
                    console.log('todo');
                    break;

            }
        });
    }

    function setStyle(editor, string, char, length) {

        if(string.length > 0) {
            let value = char.repeat(length);
            let start = string.includes(`${value}`, 0);
            let end = string.includes(`${value}`, string.length - length);

            if(start && end) {
                removeStyle(editor, string, length);
            } else {
                addStyle(editor, string, value);
            }
        }
    }

    function setBlockquote(editor, string, char, length) {

        if(string.length > 0) {
            let value = char.repeat(length);
            let start = string.includes(`${value}`, 0);

            if(start) {
                removeBlockquote(editor, string, length);
            } else {
                addBlockquote(editor, string, value);
            }
        }
    }

    function setTitle(editor, string, char, length) {

        if(string.length > 0) {
            let value = char.repeat(length);
            let start = string.includes(`${value}`, 0);

            if(start) {
                removeTitle(editor, string, length);
            } else {
                addTitle(editor, string, value);
            }
        }
    }

    function setUlList(editor, string, char, length) {

        if(string.length > 0) {
            let value = char.repeat(length);
            let start = string.includes(`${value}`, 0);

            if(start) {
                removeUlList(editor, string);
            } else {
                addUlList(editor, string, value);
            }
        }
    }

    function setOlList(editor, string, char, length) {
        if(string.length > 0) {
            let value = char.repeat(length);
            let start = string.includes(`${value}`, 0);
            if(start) {
                removeOlList(editor, string);
            } else {
                addOlList(editor, string);
            }
        }
    }

    function addStyle(editor, string, value) {
        editor.replaceSelection(`${value}${string}${value}`);
    }

    function removeStyle(editor, string, length) {
        editor.replaceSelection(string.substring(length, string.length - length));
    }

    function addBlockquote(editor, string, value) {
        editor.replaceSelection(`${value} ${string}`);
    }

    function removeBlockquote(editor, string, length) {
        editor.replaceSelection(string.substring(length, string.length - length));
    }

    function addTitle(editor, string, value) {
        editor.replaceSelection(`${value} ${string}`);
    }

    function removeTitle(editor, string, length) {
        //TODO: correct length at end
        editor.replaceSelection(string.substring(length + 1, string.length - length + 1));
    }

    function addUlList(editor, string, value) {
        editor.replaceSelection(`${value} ${string.replace(/\n/g,`\n${value} `)}`);
    }

    function removeUlList(editor, string) {
        let text = string.split("\n");
        for (let i = 0; i < text.length; i++) {
            text[i] = text[i].substring(2);
        }
        editor.replaceSelection(text.join("\n"));
    }

    function addOlList(editor, string) {
        let text = string.split("\n");

        for (let i = 0; i < text.length; i++) {
            text[i] = (text[i] === "") ? "" : (i+1) + ". " + text[i];
        }
        editor.replaceSelection(text.join("\n"));
    }

    function removeOlList(editor, string) {

        let text = string.split("\n");

        for (let i = 0; i < text.length; i++) {
            text[i] = text[i].substring(3);
        }
        editor.replaceSelection(text.join("\n"));
    }

    //Themes: material, midnight, monokai, nord, solarized-dark, tomorrow-night-bright, yonce

</script>
</body>
</html>